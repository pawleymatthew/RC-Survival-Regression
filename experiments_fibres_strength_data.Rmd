# Experiments: Fibres Strength Data

The following data is from Table 4.1 in Statistical Analysis of Reliability Data by Crowder et al. 

It shows the failure stresses (in GPa) of single carbon fibres of four different lengths (1/10/20/50mm). There is no censoring in this dataset, and while the outcome does not represent a 'time', it is non-negative and so can be modelled as such. 

The head the dataset is shown below.

```{r include=FALSE}
fibres_df <- read.csv(file = 'fibres_failure_stress.csv', header = TRUE)
fibres_df$length <- as.factor(fibres_df$length)
```

```{r echo=FALSE}
kable(head(fibres_df, n=5))
```

We a censoring indicator (all equal to 1) so that we can create survival objects needed to apply the methods used later.

```{r echo=FALSE}
fibres_df$delta <- 1
kable(head(fibres_df, n=5))
```

Make some exploratory plots. First, plot the survival curves (this may help indicate suitable assumptions about the hazards, e.g. proportional hazards becomes a power law in the survival functions). Second, plot the hazards and the odds, so we can see if PH or PO assumptions look reasonable. 

```{r echo=FALSE, fig.height=15}
par(mfrow=c(3,1))

# fit an arbitrary models
fs_arb <- flexsurvreg(Surv(fail_stress, delta) ~ length, data=fibres_df, dist="weibull")

# create the plot with est=FALSE
plot(fs_arb, est=FALSE, lwd.obs = 2, lty.obs=1, type="survival", xlab = "t", ylab = "Survival, S(t)", yaxs="i", xaxs="i")

plot(fs_arb, est=FALSE, lwd.obs = 2, lty.obs=1, type="hazard", xlab = "t", ylab = "Hazard, h(t)", yaxs="i", xaxs="i")

# plot the odds
km_fit <- survfit(Surv(fail_stress, delta) ~ length, data = fibres_df)
plot(km_fit, 
     fun = function(x) {(1-x)/x}, # odds = (1-S)/S
     lwd = 2,
     xlab = "t", ylab = "Odds, O(t)", 
     yaxs="i", xaxs="i"
     ) 
```

If we accept that the survival curves appear to be location-shifts of one another, this would indicate AFT is appropriate.

A better way to test the PH and PO assumptions is as follows (from p. 81 and p. 84)

* if PH, then a plot of the log-log survivor function against $\log t$ should reveal vertically shifted copies of the same curve;
* if PO, the log odds against $\log t$ should reveal vertically shifted copies of the same curve;

Here is the plot of log-log survivor against $\log t$:

```{r echo=FALSE}
plot(km_fit, 
     fun = "cloglog",
     lwd = 2,
     xlab = "log t", ylab = "log(-log(S(t)))", 
     yaxs="i", xaxs="i",
     main = "Log-log survival versus log t to check PH"
     ) 
```

These curves look relatively parallel, so PH might be appropriate (note: they are not straight lines, which rules out Weibull).

```{r echo=FALSE}
plot(km_fit, 
     fun = function(x) {(1-x)/x}, # odds = (1-S)/S
     log = "xy", # wants log odds against log t
     lwd = 2,
     xlab = "log t", ylab = "log odds, log O(t)", 
     yaxs="i", xaxs="i",
     main = "Log odds versus log t to check PO"
     ) 
```

The book suggests that the 1mm and 10mm curves appear to be respectively concave and convex, so PO is probably not valid. 

## Fitting the APGW PH and PO models

We now fit the PH/PO with APGW baseline models to the fibres data and see what happens.

```{r message=FALSE, warning=FALSE}
# fit PO model
fs_apgwpo_fdf <- flexsurvreg(Surv(fail_stress, delta) ~ length, 
                              data = fibres_df,
                              dist = custom.apgwpo) 
# fit PH model
fs_apgwph_fdf <- flexsurvreg(Surv(fail_stress, delta) ~ length, 
                              data = fibres_df,
                              dist = custom.apgwph) 
```

Now plot the model fit:

```{r echo=FALSE, fig.height=15}
par(mfrow=c(3,1))

# plot survival functions
plot(fs_apgwph_fdf, col = cols[1], lwd.obs = 2, lty.obs=1, type="survival",
     xlab = "t", ylab = "Survival function, S(t)", 
     main="Survival functions", yaxs="i", xaxs="i")
lines(fs_apgwpo_fdf, col = cols[2], type="survival")
legend("bottomleft", col = c("black", cols[1], cols[2]), 
       lty = c(1, 1, 1), bty = "n", lwd = rep(2, 4),
       c("Kaplan-Meier", "APGW PH", "APGW PO"))

# plot hazard functions
plot(fs_apgwph_fdf, col = cols[1], lwd.obs = 2, lty.obs=1, type="hazard",
     xlab = "t", ylab = "Hazard function, S(t)", 
     main="Hazard functions", yaxs="i", xaxs="i")
lines(fs_apgwpo_fdf, col = cols[2], type="hazard")
legend("bottomleft", col = c("black", cols[1], cols[2]), 
       lty = c(1, 1, 1), bty = "n", lwd = rep(2, 4),
       c("Kaplan-Meier", "APGW PH", "APGW PO"))

# plot odds functions
plot(km_fit, 
     fun = function(x) {(1-x)/x}, # odds = (1-S)/S
     lwd = 2,
     xlab = "t", ylab = "Odds, O(t)", main="Odds functions", 
     yaxs="i", xaxs="i"
     ) 
lines(fs_apgwph_fdf, col = cols[1], fn=odds_apgwph)
lines(fs_apgwpo_fdf, col = cols[2], fn=odds_apgwpo)
legend("topleft", col = c("black", cols[1], cols[2]), 
       lty = c(1, 1, 1), bty = "n", lwd = rep(2, 4),
       c("Non-parametric estimate", "APGW PH", "APGW PO"))
```
