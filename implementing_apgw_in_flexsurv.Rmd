# Implementing APGW in $\texttt{flexsurv}$

## Adapted power generalised Weibull (APGW)

APGW is a four-parameter distribution proposed by Burke et al. (2019). They suggest modelling the CH function by
$$H(t)=\lambda H_0((\phi t)^\gamma;\kappa)$$\
where

* $H_0(\cdot;\kappa)$ is an underlying CH function with shape parameter $\kappa>-1$;
* $\phi>0$ is the AFT parameter, controlling the horizontal scaling of the hazard;
* $\lambda>0$ is the PH parameter, controlling the vertical scaling of the hazard;
* $\gamma>0$ is a shape parameter, explicitly defined as a power parameter (unlike $\kappa$ which can be incorporated in more flexible and complicated ways).

In particular, by fixing $\lambda=1$ or $\phi=1$ we obtain two important sub-models:
$$\underbrace{H(t)=H_0((\phi t)^\gamma;\kappa)}_{\text{AFT model ($\phi$-regression)}}\qquad \underbrace{H(t)=\lambda H_0(t^\gamma;\kappa)}_{\text{PH model ($\lambda$-regression)}}$$

A specific choice for $H_0(t^\gamma;\kappa)$ is proposed, namely
$$H_A(t;\gamma,\kappa)=\frac{\kappa+1}{\kappa}\left\lbrace\left(1+\frac{t^\gamma}{\kappa+1}\right)^\kappa -1 \right\rbrace$$
with corresponding hazard function
$$h_A(t;\gamma,\kappa)=\gamma t^{\gamma -1}\left(1+\frac{t^\gamma}{\kappa+1}\right)^{\kappa-1}.$$

The APGW encompasses a broad range of popular survival distributions (e.g. Weibull, log-logistic, Gompertz) and has a more mathematically/computationally tractable form than other generalised distributions (e.g. generalised gamma).

In the most general case, we can consider the APGW multiparameter regression model given by
\begin{align*}
\log(\phi)&=x^T\tau \\
\log(\lambda)&=x^T\beta \\
\log(\gamma)&=x^T\alpha \\
\log(\kappa+1)&=x^T\nu
\end{align*}
where the log-link functions are used to ensure strict positivity of $\phi$, $\lambda$, $\gamma$ and $\kappa+1$. Here $x=(1,x_1,\ldots,x_p)^T$ is a vector of covariates and $\tau=(\tau_0,\tau_1,\ldots,\tau_p)^T$, $\beta=(\beta_0,\beta_1,\ldots,\beta_p)^T$, $\alpha=(\alpha_0,\alpha_1,\ldots,\alpha_p)^T$, $\nu=(\nu_0,\nu_1,\ldots,\nu_p)^T$ are corresponding vectors of regression coefficients. In practice, some of the parameters may only depend on selected covariates, in which case simply set the appropriate coefficients equal to zero.

The general recommendation is as follows:

* Only one scale parameter ($\phi$ or $\lambda$) depends on the covariates, while the other is fixed equal to 1;
* The power parameter $\gamma$ may depend on covariates;
* The $\kappa$ parameter is constant, i.e. $\nu_0$ is the only non-zero component of $\nu$.


## Implementing APGW as a custom distribution in $\texttt{flexsurv}$

To define a custom distribution we need the following:

* $\texttt{name}$: the name of the distribution, a string;
* Either the density function $\texttt{d<name>}$ or the hazard function $\texttt{h<name>}$, and, if available analytically, the corresponding cumulative function (i.e. the distribution function $\texttt{p<name>}$ or the cumulative hazard function $\texttt{H<name>}$). All these functions must be vectorised;
* $\texttt{pars}$: character vector naming the parameters, matching the arguments of the functions and in the same order;
* $\texttt{location}$: name of the location parameter (in the $\texttt{flexsurv}$ sense), a character;
* $\texttt{transforms}$: list of functions transforming the parameters to the real line;
* $\texttt{inv.transforms}$: list of the corresponding inverse functions;
* $\texttt{inits}$: a function specifying plausible initial values for the parameters in terms of the data.


```{r}
# hazard function
hapgw <- function(x, phi, lambda, gamma, kappa, log=FALSE){
  lambda*gamma*phi^gamma*(x)^{gamma-1}*(1+((phi*x)^gamma)/(kappa+1))^(kappa-1)
}

# cumulative hazard function
Hapgw <- function(x, phi, lambda, gamma, kappa, log=FALSE){
  lambda*(kappa+1)/kappa * ((1 + (phi*x)^gamma/(kappa+1))^kappa - 1)
}
  
# function to transform kappa to real line (and the inverse)
kappa_transform <- function(x){log(x+1)}
kappa_inv_transform <- function(x){exp(x)-1}

custom.apgw <- list(name="apgw",
                    pars=c("phi","lambda","gamma","kappa"),
                    location="lambda",
                    transforms=c(log,log,log,kappa_transform),
                    inv.transforms=c(exp,exp,exp,kappa_inv_transform),
                    inits=function(t)c(1,1,1,1)
                    )
```

The initial parameter values are set as 1. This is because $\kappa=\gamma=1$ corresponds to the exponential distribution (a reasonable choice to begin with), and sets the default value for $\lambda$ and $\phi$ to one, meaning we can restrict the model to the PH or AFT sub-models simply by passing $\texttt{fixedpars}=1$ or $\texttt{fixedpars}=2$ respectively when we call $\texttt{flexsurvreg}$. 

Now fit the APGW model to the $\texttt{bc}$ dataset. Here we use the AFT model, i.e. fix $\lambda=1$ and allow $\phi$ to depend on the covariates. The power parameter $\gamma$ also depends on the covariate, but $\kappa$ is a constant.

```{r message=FALSE}
fs_apgw_aft <- flexsurvreg(Surv(recyrs,censrec) ~ group + gamma(group),
                   fixedpars=2, # fix lambda=1 (1 is init value)
                   data = bc, 
                   dist = custom.apgw) # specify my custom dist
```

## Checking the APGW model fit

To test the APGW model, we fit some alternative models for comparison:

* Weibull (AFT) - only the scale parameter depends on the covariates;
* Generalised gamma (AFT) - only the parameter $\mu$ depends on the covariates.

```{r message=FALSE, warning=FALSE}
fs_weibull_aft <- flexsurvreg(Surv(recyrs,censrec) ~ group, data=bc, dist="weibull")
fs_gg_aft <- flexsurvreg(Surv(recyrs,censrec) ~ group, data=bc, dist="gengamma")
```

Now we create plots of the model fit:

```{r fig.height = 13, fig.width=15}
cols = c("#E495A5", "#86B875", "#7DB0DD")
par(mfrow=c(2,2))

plot(fs_weibull_aft, col = cols[1], lwd.obs = 2, lty.obs=1, xlab = "t (years)", ylab = "Survival function, S(t)", main="Survival functions", yaxs="i", xaxs="i")
lines(fs_gg_aft, col = cols[2])
lines(fs_apgw_aft, col = cols[3])
text(x=c(2.1,3.5,4), y=c(0.4, 0.52, 0.72), c("Poor","Medium","Good"))
legend("bottomleft", col = c("black", cols[1], cols[2], cols[3]), 
       lty = c(1, 1, 1, 1), bty = "n", lwd = rep(2, 4),
       c("Kaplan-Meier", "Weibull (AFT)", "Generalized gamma (AFT)",
         "APGW (AFT)"))

plot(fs_gg_aft, col = cols[3], lwd.obs = 2, lty.obs=1, ci=TRUE, col.ci="red", type="survival", xlab = "t (years)", ylab = "Survival function, S(t)", main="APGW survival function with CI", yaxs="i", xaxs="i")
text(x=c(2.1,3.5,4), y=c(0.4, 0.52, 0.72), c("Poor","Medium","Good"))
legend("bottomleft", col = c("black", cols[3],"red"), 
       lty = c(1, 1, 2), bty = "n", lwd = rep(2, 4, 2),
       c("Kaplan-Meier", "APGW (AFT)", "APGW (AFT) 95% CI"))

plot(fs_weibull_aft, col = cols[1], lwd.obs = 2, lty.obs=1, type="hazard", xlab = "t (years)", ylab = "Hazard, h(t)", main="Hazard functions", ylim=c(0,0.6), yaxs="i", xaxs="i")
lines(fs_gg_aft, col = cols[2], type="hazard")
lines(fs_apgw_aft, col = cols[3], type="hazard")
text(x=c(0.7,1.7,2.5), y=c(0.39, 0.22, 0.03), c("Poor","Medium","Good"))
legend("topleft", col = c("black", cols[1], cols[2], cols[3]), 
       lty = c(1, 1, 1, 1), bty = "n", lwd = rep(2, 4),
       c("Kernel density estimate", "Weibull (AFT)", "Generalized gamma (AFT)",
         "APGW (AFT)"))

plot(fs_weibull_aft, col = cols[1], lwd.obs = 2, lty.obs=1, type="cumhaz", xlab = "t (years)", ylab = "Cumulative hazard, H(t)", main="Cumulative hazard functions", yaxs="i", xaxs="i")
lines(fs_gg_aft, col = cols[2], type="cumhaz")
lines(fs_apgw_aft, col = cols[3], type="cumhaz")
text(x=c(3,3.6,4), y=c(1.1, 0.7, 0.1), c("Poor","Medium","Good"))
legend("topleft", col = c("black", cols[1], cols[2], cols[3]), 
       lty = c(1, 1, 1, 1), bty = "n", lwd = rep(2, 4),
       c("Nelson-Aalen", "Weibull (AFT)", "Generalized gamma (AFT)",
         "APGW (AFT)"))
```

Comments about the survival functions:

* The APGW and generalised gamma models give very similar fits, and fit the data (i.e. the non-parameter Kaplan-Meier estimate for the survival function) well.
* The 95% CI for the APGW model appear to be accurate for ech group.
* The performance of the Weibull model also appears to be OK, although the shape parameter for the 'Poor' group appears to be off, overestimating survival at early times, and underestimating later on (we see from the hazard plots that actually the issue is that the shape of the hazard function for the 'Poor' group is one that the Weibull model is unable to capture).

Comments about the hazard functions:

* Unlike the Weibull model, the APGW and generalised gamma models are capable of modelling a greater variety of hazard shapes. This advantage is utilised for the 'Poor' and 'Good' groups, where the hazard function has a $\cap$ shape. 