---
title: "Exploring flexsurv"
author: "Matthew Pawley"
date: "Semester 1, 2020-21"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("flexsurv")
library("survival")
library("knitr")
set.seed(321)
```

# Exploring flexsurv

## Introduction

$\texttt{flexsurv}$ is an R package for parametric survival analysis. The [CRAN vignette](https://cran.r-project.org/web/packages/flexsurv/flexsurv.pdf) provides a detailed list of the package's functionality, while [this RSS guide](https://www.jstatsoft.org/article/view/v070i08) gives a more readable overview (and the [source file](https://github.com/chjackson/flexsurv-dev/blob/master/vignettes/flexsurv.Rnw) provides all the code).

The main features of the packages are:

* Fit any parametric survival distribution, given a pdf or hazard function (as well as their cumulative counterparts, preferably);
* Built-in commonly used survival distributions;
* Model any parameter of any distribution as a linear or log-linear function of the covariates.

While the semi-parametric Cox model is very popular, primarily because the effects of covariates can be estimated without requiring knowledge of the baseline survival distribution, there are advantages to fully-parametric approaches in some cases.

The $\texttt{flexsurv}$ package provides a set of tools for parametric modelling. The syntax is designed to be consistent with the $\texttt{survival}$ package (the standard package for survival analysis in R) but $\texttt{flexsurv}$ goes beyond $\texttt{survival}$ in that it allows for more flexible modelling, e.g. $\texttt{survival}$ only supports two-parameter location-scale distributions.

## Parametric survival models

### General model

The general model fitted by $\texttt{flexsurv}$ has a PDF for death at time $t$ given by 
\begin{equation}\label{eqn:general_model}
f(t|\mu(\boldsymbol{z}),\boldsymbol{\alpha}(\boldsymbol{z})), \quad t\geq 0
\end{equation}
We define also the CDF $F(t)$, the survival function $S(t)=1-F(t)$, the hazard function $h(t)=f(t)/S(t)$ and the cumulative hazard $H(t)=-\log S(t)$. The parameter of primary interest (usually a location parameter)
 is $\mu=\alpha_0$, while the parameters $\boldsymbol{\alpha}=(\alpha_1,\ldots,\alpha_R)$ are ancillary (usually related to higher moments).
 
The parameters generally depend on the covariate vector $\boldsymbol{z}$ through link-transformed linear models
 \begin{align}
  g_0(\mu(\boldsymbol{z})) &=\gamma_0+\boldsymbol{\beta}_0^T\boldsymbol{z} \label{eqn:link_function_1} \\ 
  g_r(\alpha_r(\boldsymbol{z}))&=\gamma_r+\boldsymbol{\beta}_r^T\boldsymbol{z} \label{eqn:link_function_2}
\end{align}
Typically $g(\cdot)$ will be identity for unrestricted parameters and $\log(\cdot)$ for positive parameters.
 
### Proportional hazards model
 
 If the location parameter depends on the covariates, but the ancillary parameters don't then the hazard function factorises as 
$$h(t|\mu(\boldsymbol{z}),\boldsymbol{\alpha})=h_0(t|\boldsymbol{\alpha})\mu(\boldsymbol{z}).$$
This is a proportional hazards (PH) model: for any two individuals with covariates $\boldsymbol{z}_1$, $\boldsymbol{z}_2$, the hazard ratio 
$$\frac{h_1(t|\mu(\boldsymbol{z}_1),\boldsymbol{\alpha})}{h_1(t|\mu(\boldsymbol{z}_2),\boldsymbol{\alpha})}=\frac{h_0(t|\boldsymbol{\alpha})\mu(\boldsymbol{z}_1)}{h_0(t|\boldsymbol{\alpha})\mu(\boldsymbol{z}_2)}=\frac{\mu(\boldsymbol{z}_1)}{\mu(\boldsymbol{z}_2)}$$ is constant over time.

### Acclerated failure time (AFT) model

If $S(t|\mu(\boldsymbol{z}),\boldsymbol{\alpha})=S_0(\mu(\boldsymbol{z})t|\boldsymbol{\alpha})$ then it is an accelerated failure time (AFT), where the covariate effect is multiplicative with respect to the survival time.

### Data

Let $\{(t_i,\delta_i,s_i)\}_{i=1}^n$ be a set of survival data, where 

* $t_i$ denotes the event/censoring time of individual $i$;
* $\delta_i$ is the censoring indicator for individual $i$, i.e. $\delta_i=1$ if $t_i$ is an observed event time and $\delta_i=0$ if $t_i$ represents the (right) censoring time;
* $s_i$ is the left-truncation time for individual $i$, i.e. the $i$th survival time is only observed conditionally on the individual having survived up to time $s_i$. If there is no left-truncation, then $s_i=0$.

### Likelihood

The likelihood for the parameters $\boldsymbol{\theta}=(\boldsymbol{\gamma},\boldsymbol{\beta})$ from Equation \ref{eqn:general_model} is given by
\begin{equation}\label{eqn:lkhd}
l(\boldsymbol{\theta}|\boldsymbol{t},\boldsymbol{\delta},\boldsymbol{s})=\frac{\prod_{i:\,\delta_i=1}f_i(t_i)\prod_{i:\,\delta_i=1}S_i(t_i)}{\prod_{i}S_i(s_i)}.
\end{equation}
where
\begin{align*}
f_i(t_i) &= f_i(t_i|\mu(\boldsymbol{z}_i),\boldsymbol{\alpha}(\boldsymbol{z}_i)) \\
S_i(t_i) &= S_i(t_i|\mu(\boldsymbol{z}_i),\boldsymbol{\alpha}(\boldsymbol{z}_i)) \\
\end{align*}
for brevity and $\mu,\boldsymbol{\alpha}$ are related to $\gamma,\boldsymbol{\beta},\boldsymbol{z}_i$ via the link functions in Equations \ref{eqn:link_function_1} and \ref{eqn:link_function_2}. Note that if there is no left-truncation, then the denominator of Equation \ref{eqn:lkhd} equals one.

The log-likelihood can be expressed in a more useful form involving the hazard and cumulative hazard functions, given by 
\begin{equation}\label{eqn:log_lkhd}
\log l(\boldsymbol{\theta}|\boldsymbol{t},\boldsymbol{\delta},\boldsymbol{s})=\sum_{i:\,\delta_i=1}\log h_i(t_i) - \sum_{i}H_i(t_i) +\sum_{i} H_i(s_i).
\end{equation}
Again we suppress the conditionalities for brevity and in the case where there is no left-truncation the final term vanishes.

For these likelihoods to be valid, we assume the individual survival times are independent and the censoring times are distributed independently of the parameters $\boldsymbol{\theta}$.

## Fitting standard parametric survival models

### The $\texttt{bc}$ dataset

To demonstrate the functionality of $\texttt{flexsurv}$, we use the in-built dataset $\texttt{bc}$, which contains 686 patients with breast cancer. 

```{r message=FALSE}
kable(head(bc))
```

The columns of the dataset are as follows:

* $\texttt{censrec}$ is the censoring indicator (1=dead, 0=censored);
* $\texttt{rectime}$ is the death/censoring time in days;
* $\texttt{group}$ is the prognostic group, either "Good", "Medium" or "Poor";
* $\texttt{recyrs}$ is the death/censoring time in years.

### Fitting a model

The main model-fitting function is $\texttt{flexsurvreg}$. The first argument is an R formula, of which the left-hand side is an R survival object, created using the $\texttt{Surv}$ function from the $\texttt{survival}$ package.

```{r}
fs1 <- flexsurvreg(Surv(recyrs,censrec) ~ group, # the 'formula'
                   data = bc, # the data set
                   dist = "weibull") # specify the parametric distribution
```

If the $\texttt{dist}$ argument is a string, then it uses a built in parametric distribution; otherwise we can specify a custom distribution. If we have left-truncation times as variable in our data set, we add this as the first argument in the $\texttt{Surv}$ call. 

Printing the fitted model gives useful information, including the parameter estimates and associated confidence intervals. 

```{r}
fs1
```

To know what parametrisation has been used, consult the documentation (they can differ from those used by $\texttt{survreg}$ from the $\texttt{survival}$ package).

$\texttt{flexsurvreg}$ has a range of built-in distributions. For distributions whose density functions are provided in the standard R installation, $\texttt{flexsurvreg}$ will use these functions ($\texttt{dexp}$, $\texttt{dweibull}$, etc.) in internal calculations, and will use the same parametrisation. $\texttt{flexsurv}$ provides a range of additional survival distributions; consult the documentation for details. 

### Covariates on ancillary parameters

We now fit two generalised gamma models (a three-parameter family of distributions which generalises the Weibull, gamma, and log-normal) to the $\texttt{bc}$ dataset.

The first model, $\texttt{fs2}$, is an AFT model where only the parameter $\mu$ depends on the prognostic covariate $\texttt{group}$. In the second model, $\texttt{fs3}$, the first ancillary parameter $\texttt{sigma}$ also depends on the covariate (the resulting model is neither PH nor AFT). The second ancillary parameter $\texttt{Q}$ is common for all prognostic groups. 

```{r}
fs2 <- flexsurvreg(Surv(recyrs,censrec)~group, data = bc, dist = "gengamma")
fs3 <- flexsurvreg(Surv(recyrs,censrec)~group+sigma(group), data = bc, dist = "gengamma")
```

### Plotting outputs

The $\texttt{plot()}$ method can be applied to $\texttt{flexsurvreg}$ objects. This will draw the Kaplan-Meier estimate of the survival function (one for each combination of covariates, or just a single population average curve if there are no categorical covariates), and overlays the corresponding estimates from the fitted models. Further model fits can be added using the $\texttt{lines()}$ method (and this is the approach that should be taken for publication level plots, the $\texttt{plot()}$ method is only intended for model fit checking purposes). By changing the $\texttt{type}$ argument we can plot the hazard or cumulative hazard function instead.

### Model summaries

Any function $\texttt{fn}$ of the parameters of a fitted model can be summarised by passing $\texttt{fn}$ into the $\texttt{summary()}$ method. Confidence intervals are obtained by bootstrap sampling, the argument $\texttt{B}$ can be adjusted to obtain the desired level of precision.

```{r}
median.weibull <- function(shape, scale){qweibull(0.5, shape, scale)}
summary(fs1, fn=median.weibull, t=2, B=10000)
```

### Computation

$\texttt{flexsurvreg}$ maximises the likelihood using the R function $\texttt{optim}$. The derivatives for standard distributions are built in. For custom distributions, the user can optionally supply functions to calculate the log density and log survival functions (with respect to the transformed baseline parameters $\boldsymbol{\gamma}$).

### Custom survival distributions

$\texttt{flexsurv}$ can work with any survival model of the form (\ref{eqn:general_model}), if either the density or hazard function is provided. 
To supply a custom distribution to $\texttt{flexsurvreg}$, the $\texttt{dist}$ argument should be a $\texttt{list}$ object containing the name of the distribution ($\texttt{name}$) and at least one of the density function ($\texttt{d<name>}$) or the hazard function ($\texttt{h<name>}$). If analytic forms for the cumulative distribution or cumulative hazard are available, these should be supplied too, as ($\texttt{p<name>}$ and $\texttt{H<name>}$ respectively (if not, $\texttt{flexsurv}$ will compute them internally using numerical integration, which makes model fitting take longer and potentially become unstable). 

All the functions supplied must be vectorised and accept an argument $\texttt{log}$, which when $\texttt{TRUE}$, returns the log density/hazard. If the desired functions are available in another contributed R package, they can be used, but a wrapper may be needed to convert them into an acceptable form for $\texttt{flexsurvreg}$.